# ══════════════════════════════════════════════════════════════════════
# Kujuana API — Production Environment Variables
# Copy this file to .env and fill in every value before deploying.
# NEVER commit .env to git. This example file is safe to commit.
# ══════════════════════════════════════════════════════════════════════

# ── Server ────────────────────────────────────────────────────────────
NODE_ENV=production
PORT=4000

# ── Database ──────────────────────────────────────────────────────────
MONGODB_URI=mongodb+srv://<user>:<password>@<cluster>.mongodb.net/kujuana?retryWrites=true&w=majority

# ── JWT Auth ──────────────────────────────────────────────────────────
# Generate with: node -e "console.log(require('crypto').randomBytes(48).toString('hex'))"
JWT_SECRET=<min-48-char-random-string>
JWT_REFRESH_SECRET=<min-48-char-random-string>

# Cookie domain — must start with a dot to cover all subdomains
COOKIE_DOMAIN=.kujuana.com

# ── Field Encryption (AES-256-GCM) ───────────────────────────────────
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
# Must be exactly 64 hex characters (32 bytes).
ENCRYPTION_KEY=<64-hex-chars>

# ── M-Pesa (Safaricom Daraja API) ─────────────────────────────────────
# Portal: https://developer.safaricom.co.ke/
# Set MPESA_ENV=live for production
MPESA_ENV=live
MPESA_CONSUMER_KEY=
MPESA_CONSUMER_SECRET=
MPESA_SHORTCODE=
MPESA_PASSKEY=
# Must be HTTPS — Safaricom rejects non-HTTPS callbacks
MPESA_CALLBACK_URL=https://api.kujuana.com/api/v1/payments/webhook/mpesa
MPESA_TRANSACTION_TYPE=CustomerPayBillOnline

# ── Pesapal v3 ────────────────────────────────────────────────────────
# Portal: https://developer.pesapal.com/
PESAPAL_ENV=live
PESAPAL_CONSUMER_KEY=
PESAPAL_CONSUMER_SECRET=
# Register this URL in Pesapal dashboard → IPN Settings
PESAPAL_IPN_URL=https://api.kujuana.com/api/v1/payments/webhook/pesapal

# ── Paystack ──────────────────────────────────────────────────────────
# Portal: https://dashboard.paystack.com/#/settings/developers
PAYSTACK_PUBLIC_KEY=pk_live_
PAYSTACK_SECRET_KEY=sk_live_
# Register this URL in Paystack dashboard → Settings → Webhooks
# This is where the user lands after completing checkout
PAYSTACK_CALLBACK_URL=https://kujuana.com/subscription?status=return

# ── Stripe ────────────────────────────────────────────────────────────
# Portal: https://dashboard.stripe.com/apikeys
STRIPE_SECRET_KEY=sk_live_
STRIPE_PUBLISHABLE_KEY=pk_live_
# Get from: Stripe Dashboard → Developers → Webhooks → Add endpoint
# Endpoint URL: https://api.kujuana.com/api/v1/payments/webhook/stripe
# Events to listen for: checkout.session.completed
STRIPE_WEBHOOK_SECRET=whsec_

# ── Flutterwave v3 (coming soon) ──────────────────────────────────────
# Portal: https://dashboard.flutterwave.com/dashboard/settings/webhooks
FLUTTERWAVE_PUBLIC_KEY=FLWPUBK_LIVE-
FLUTTERWAVE_SECRET_KEY=FLWSECK_LIVE-
# Set this in Flutterwave dashboard → Settings → Webhooks → Secret Hash
FLUTTERWAVE_WEBHOOK_SECRET=

# ── Cloudinary (photo storage) ────────────────────────────────────────
# Portal: https://cloudinary.com/console
# All photos are stored as PRIVATE — never set to public delivery
CLOUDINARY_CLOUD_NAME=
CLOUDINARY_API_KEY=
CLOUDINARY_API_SECRET=

# ── Email (SMTP) ──────────────────────────────────────────────────────
SMTP_HOST=smtp.resend.com
SMTP_PORT=587
SMTP_USER=resend
SMTP_PASS=<resend-api-key>
EMAIL_FROM=noreply@kujuana.com

# ── Redis / Upstash ───────────────────────────────────────────────────
# For OTP storage and rate limiting
# Portal: https://console.upstash.com/
UPSTASH_REDIS_REST_URL=https://<name>.upstash.io
UPSTASH_REDIS_REST_TOKEN=

# ── BullMQ (uses same Redis) ──────────────────────────────────────────
# BullMQ reads UPSTASH_REDIS_REST_URL above. No extra env needed
# unless you use a separate Redis instance for queues.

# ── Web URLs (used in emails and payment redirects) ───────────────────
WEB_URL=https://kujuana.com

# ══════════════════════════════════════════════════════════════════════
# PRODUCTION CHECKLIST
# ══════════════════════════════════════════════════════════════════════
#
# 1. WEBHOOK REGISTRATION
#    ─ Paystack:    Dashboard → Settings → API Keys & Webhooks → Add Webhook URL
#                  URL: https://api.kujuana.com/api/v1/payments/webhook/paystack
#    ─ Pesapal:    Dashboard → IPN Settings → Add IPN URL (PESAPAL_IPN_URL above)
#    ─ Stripe:     Dashboard → Developers → Webhooks → Add endpoint
#                  URL: https://api.kujuana.com/api/v1/payments/webhook/stripe
#                  Events: checkout.session.completed
#                  Copy "Signing secret" → STRIPE_WEBHOOK_SECRET
#    ─ Flutterwave: Dashboard → Settings → Webhooks → Set URL + Secret Hash
#                  URL: https://api.kujuana.com/api/v1/payments/webhook/flutterwave
#    ─ M-Pesa:     Registered via MPESA_CALLBACK_URL — must be HTTPS
#
# 2. NGINX / REVERSE PROXY
#    ─ Proxy API:  proxy_pass http://localhost:4000;
#    ─ Headers:    proxy_set_header X-Forwarded-Proto $scheme;
#                  proxy_set_header X-Real-IP $remote_addr;
#    ─ SSL:        certbot --nginx -d api.kujuana.com
#
# 3. WEB APP ENV
#    ─ Set in apps/web/.env.production:
#      NEXT_PUBLIC_API_URL=https://api.kujuana.com/api/v1
#
# 4. MOBILE APP CONFIG
#    ─ Set in apps/mobile/lib/api/config.ts (or env):
#      baseUrl: 'https://api.kujuana.com/api/v1'
#      webUrl:  'https://kujuana.com'
#
# 5. MONGODB ATLAS
#    ─ Whitelist your VPS IP: Atlas → Network Access → Add IP
#    ─ Create Atlas Search indexes: pnpm ensure-indexes
#
# 6. COOKIES
#    ─ COOKIE_DOMAIN must be .kujuana.com (with leading dot)
#    ─ Nginx must pass X-Forwarded-Proto so cookies are set as Secure
#
# 7. PROCESS MANAGER
#    ─ Use PM2: pm2 start dist/server.js --name kujuana-api
#    ─ Save:    pm2 save && pm2 startup
