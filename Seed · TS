/**
 * Development Seed Script
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Populates MongoDB Atlas with realistic test data for local development.
 *
 * Creates:
 *   - 1 admin user
 *   - 1 matchmaker user
 *   - 10 standard users (complete profiles, mixed genders)
 *   - 3 priority users (with credit balances)
 *   - 2 VIP users (with add-ons)
 *   - Sample matches between users
 *   - Sample payments
 *   - Subscriptions for all users
 *
 * Usage:
 *   npx ts-node src/seeds/seed.ts
 *   npx ts-node src/seeds/seed.ts --clear   (drops collections first)
 */

import mongoose from 'mongoose'
import { connectDB } from '../config/db.js'
import {
  User, Profile, Match, Subscription, Payment,
} from '../models/index.js'
import {
  Gender,
  RelationshipStatus,
  RelationshipType,
  ChildrenPreference,
  EmotionalReadiness,
  SubscriptionTier,
  SubscriptionStatus,
  PaymentGateway,
  PaymentStatus,
  PaymentPurpose,
  MatchStatus,
  UserRole,
  VipAddOn,
} from '../types/index.js'

const CLEAR = process.argv.includes('--clear')

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const pick = <T>(arr: T[]): T => arr[Math.floor(Math.random() * arr.length)]
const pickN = <T>(arr: T[], n: number): T[] =>
  [...arr].sort(() => Math.random() - 0.5).slice(0, n)
const rand = (min: number, max: number) =>
  Math.floor(Math.random() * (max - min + 1)) + min

const NAIROBI_COORDS: [number, number] = [36.8219, -1.2921] // [lng, lat]
const MOMBASA_COORDS: [number, number] = [39.6682, -4.0435]
const KAMPALA_COORDS: [number, number] = [32.5825, 0.3476]
const LONDON_COORDS:  [number, number] = [-0.1276, 51.5074]
const TORONTO_COORDS: [number, number] = [-79.3832, 43.6532]

const COORD_POOL = [
  NAIROBI_COORDS, MOMBASA_COORDS, KAMPALA_COORDS, LONDON_COORDS, TORONTO_COORDS
]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SEED DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function seed() {
  await connectDB()

  if (CLEAR) {
    console.log('ğŸ—‘  Clearing collections...')
    await Promise.all([
      User.deleteMany({}),
      Profile.deleteMany({}),
      Match.deleteMany({}),
      Subscription.deleteMany({}),
      Payment.deleteMany({}),
    ])
    console.log('âœ… Cleared\n')
  }

  // â”€â”€ Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const admin = await User.create({
    fullName:        'Kujuana Admin',
    email:           'admin@kujuana.com',
    phone:           '+254700000001',
    passwordHash:    'Admin@kujuana2024!',
    isEmailVerified: true,
    role:            UserRole.Admin,
  })
  console.log(`âœ… Admin: ${admin.email}`)

  // â”€â”€ Matchmaker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const matchmaker = await User.create({
    fullName:        'Grace Wanjiku',
    email:           'grace@kujuana.com',
    phone:           '+254700000002',
    passwordHash:    'Matchmaker@2024!',
    isEmailVerified: true,
    role:            UserRole.Matchmaker,
  })
  console.log(`âœ… Matchmaker: ${matchmaker.email}`)

  // â”€â”€ Regular Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const usersData = [
    // Standard tier â€” female
    {
      fullName: 'Amina Hassan',      email: 'amina@test.com',   phone: '+254711111001',
      gender: Gender.Female, age: 28, tier: SubscriptionTier.Standard,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'Software Engineer', relationshipType: RelationshipType.Marriage,
    },
    {
      fullName: 'Zawadi Ochieng',    email: 'zawadi@test.com',  phone: '+254711111002',
      gender: Gender.Female, age: 32, tier: SubscriptionTier.Standard,
      coords: MOMBASA_COORDS, country: 'Kenya', city: 'Mombasa',
      occupation: 'Doctor', relationshipType: RelationshipType.LongTerm,
    },
    {
      fullName: 'Njeri Kamau',       email: 'njeri@test.com',   phone: '+254711111003',
      gender: Gender.Female, age: 26, tier: SubscriptionTier.Standard,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'Teacher', relationshipType: RelationshipType.Friendship,
    },
    {
      fullName: 'Halima Abdi',       email: 'halima@test.com',  phone: '+254711111004',
      gender: Gender.Female, age: 35, tier: SubscriptionTier.Standard,
      coords: KAMPALA_COORDS, country: 'Uganda', city: 'Kampala',
      occupation: 'Entrepreneur', relationshipType: RelationshipType.Marriage,
    },
    {
      fullName: 'Aisha Mwangi',      email: 'aisha@test.com',   phone: '+254711111005',
      gender: Gender.Female, age: 29, tier: SubscriptionTier.Standard,
      coords: LONDON_COORDS, country: 'United Kingdom', city: 'London',
      occupation: 'Nurse', relationshipType: RelationshipType.LongTerm,
    },
    // Standard tier â€” male
    {
      fullName: 'Brian Otieno',      email: 'brian@test.com',   phone: '+254711111006',
      gender: Gender.Male, age: 31, tier: SubscriptionTier.Standard,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'Accountant', relationshipType: RelationshipType.Marriage,
    },
    {
      fullName: 'Samuel Kariuki',    email: 'samuel@test.com',  phone: '+254711111007',
      gender: Gender.Male, age: 27, tier: SubscriptionTier.Standard,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'Lawyer', relationshipType: RelationshipType.LongTerm,
    },
    {
      fullName: 'David Mutua',       email: 'david@test.com',   phone: '+254711111008',
      gender: Gender.Male, age: 34, tier: SubscriptionTier.Standard,
      coords: MOMBASA_COORDS, country: 'Kenya', city: 'Mombasa',
      occupation: 'Architect', relationshipType: RelationshipType.Marriage,
    },
    // Priority tier
    {
      fullName: 'Fatuma Yusuf',      email: 'fatuma@test.com',  phone: '+254711111009',
      gender: Gender.Female, age: 30, tier: SubscriptionTier.Priority,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'Marketing Manager', relationshipType: RelationshipType.Marriage,
    },
    {
      fullName: 'Kevin Nderitu',     email: 'kevin@test.com',   phone: '+254711111010',
      gender: Gender.Male, age: 33, tier: SubscriptionTier.Priority,
      coords: TORONTO_COORDS, country: 'Canada', city: 'Toronto',
      occupation: 'Data Scientist', relationshipType: RelationshipType.LongTerm,
    },
    {
      fullName: 'Mercy Wambua',      email: 'mercy@test.com',   phone: '+254711111011',
      gender: Gender.Female, age: 28, tier: SubscriptionTier.Priority,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'Pharmacist', relationshipType: RelationshipType.Marriage,
    },
    // VIP tier
    {
      fullName: 'Catherine Njuguna', email: 'catherine@test.com', phone: '+254711111012',
      gender: Gender.Female, age: 36, tier: SubscriptionTier.VIP,
      coords: LONDON_COORDS, country: 'United Kingdom', city: 'London',
      occupation: 'Investment Banker', relationshipType: RelationshipType.Marriage,
    },
    {
      fullName: 'James Githinji',    email: 'james@test.com',   phone: '+254711111013',
      gender: Gender.Male, age: 38, tier: SubscriptionTier.VIP,
      coords: NAIROBI_COORDS, country: 'Kenya', city: 'Nairobi',
      occupation: 'CEO', relationshipType: RelationshipType.Marriage,
    },
  ]

  const createdUsers: mongoose.Types.ObjectId[] = []
  const SYSTEM_USER_ID = new mongoose.Types.ObjectId() // pseudo-ID for system matches

  for (const ud of usersData) {
    const user = await User.create({
      fullName:        ud.fullName,
      email:           ud.email,
      phone:           ud.phone,
      passwordHash:    'Password@123!',
      isEmailVerified: true,
      role:            UserRole.User,
    })

    const profile = await Profile.create({
      userId:             user._id,
      gender:             ud.gender,
      age:                ud.age,
      location: {
        city:        ud.city,
        country:     ud.country,
        countryCode: ud.country === 'Kenya' ? 'KE' : ud.country === 'Uganda' ? 'UG' : ud.country === 'Canada' ? 'CA' : 'GB',
        coordinates: { type: 'Point', coordinates: ud.coords },
      },
      relationshipStatus:  RelationshipStatus.Single,
      occupation:          ud.occupation,
      lifestyle:           pickN(['active', 'traveller', 'foodie', 'spiritual', 'career-driven', 'family-oriented'], rand(2, 4)),
      personalityTraits:   pickN(['empathetic', 'ambitious', 'grounded', 'nurturing', 'optimistic', 'humorous'], rand(2, 4)),
      hasChildren:         false,
      childrenCount:       0,
      wantsChildren:       pick([ChildrenPreference.Yes, ChildrenPreference.Open]),
      emotionalReadiness:  pick([EmotionalReadiness.Ready, EmotionalReadiness.Exploring]),
      religion:            pick(['christian', 'muslim', 'catholic', 'agnostic']),
      photos:              [],  // no real photos in seed
      relationshipType:    ud.relationshipType,
      partnerValues:       pickN(['honesty', 'ambition', 'kindness', 'family-oriented', 'spirituality', 'loyalty'], rand(2, 4)),
      idealPartnerDescription: `Looking for someone who is genuine, driven, and values family. I believe in building a life together with shared goals.`,
      lifeVision:          `A loving home, meaningful work, and adventures together around the world.`,
      nonNegotiables:      pickN(['Must be honest', 'Must want children', 'Must be financially independent'], rand(1, 2)),
      preferences: {
        ageRange:     { min: ud.age - 5, max: ud.age + 7 },
        countries:    [ud.country === 'Kenya' ? 'KE' : 'KE'],
        lifestyle:    ['active', 'traveller'],
        religion:     'any',
        international: ud.tier === SubscriptionTier.VIP,
      },
      onboardingStep:     6,
      onboardingComplete: true,
      isActive:           true,
    })

    // â”€â”€ Subscription â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const now = new Date()
    const sub: any = {
      userId: user._id,
      tier:   ud.tier,
      status: SubscriptionStatus.Active,
    }

    if (ud.tier === SubscriptionTier.Priority) {
      sub.priorityCredits      = rand(2, 8)
      sub.totalCreditsPurchased = sub.priorityCredits + rand(0, 5)
    }

    if (ud.tier === SubscriptionTier.VIP) {
      sub.vipMatchesUsedThisCycle = rand(0, 5)
      sub.vipCycleStartedAt       = now
      sub.vipCycleResetAt         = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)
      sub.currentPeriodStart      = now
      sub.currentPeriodEnd        = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)
      sub.vipAddOns               = [VipAddOn.InternationalSearch, VipAddOn.LocationFiltering, VipAddOn.StrictAgeFiltering]
      sub.autoRenew               = true
    }

    await Subscription.create(sub)
    createdUsers.push(user._id)
    console.log(`âœ… User [${ud.tier.padEnd(8)}]: ${ud.fullName} (${ud.email})`)
  }

  // â”€â”€ Sample Match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [userA, userB] = createdUsers.slice(0, 2)
  const match = await Match.create({
    users:             [userA, userB].sort(),
    initiatedBy:       SYSTEM_USER_ID,
    initiatedBySystem: true,
    tier:              SubscriptionTier.Standard,
    compatibilityScore: 78,
    scoreBreakdown: {
      relationshipGoals:  85,
      partnerValues:      80,
      lifestyle:          75,
      preferences:        70,
      emotionalReadiness: 80,
    },
    status:       MatchStatus.Introduced,
    introducedAt: new Date(),
    creditUsed:   false,
    expiresAt:    new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
  })
  console.log(`\nâœ… Sample match created: ${match._id}`)

  // â”€â”€ Sample Payment (Priority) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const priorityUser = createdUsers[8] // Fatuma â€” priority tier
  await Payment.create({
    userId:         priorityUser,
    gateway:        PaymentGateway.Mpesa,
    reference:      'QHX4KMVP9Y',
    internalRef:    `KUJ-${Date.now()}-001`,
    idempotencyKey: `seed-payment-001-${Date.now()}`,
    amount:         2000,
    currency:       'KES',
    amountInKes:    2000,
    purpose:        PaymentPurpose.PriorityBundle5,
    creditsGranted: 5,
    status:         PaymentStatus.Completed,
    phone:          '+254711111009',
    completedAt:    new Date(),
    metadata: {
      mpesaReceiptNumber: 'QHX4KMVP9Y',
      transactionDate:    new Date().toISOString(),
      phoneNumber:        '+254711111009',
    },
  })
  console.log(`âœ… Sample payment created`)

  console.log(`\nğŸ‰ Seed complete!`)
  console.log(`   Admin: admin@kujuana.com / Admin@kujuana2024!`)
  console.log(`   Test:  brian@test.com    / Password@123!`)

  await mongoose.disconnect()
}

seed().catch((err) => {
  console.error('âŒ Seed failed:', err)
  process.exit(1)
})
